# 要件定義書: Phase 3 - AI 文章添削アシスタント機能

## プロジェクト概要

**プロジェクト名**: WorkNote - Phase 3: AI 文章添削アシスタント

**目的**: Claude Code を活用した AI 文章添削機能を追加し、ユーザーが入力した Markdown 文章の品質を向上させる

**スコープ**: 詳細入力ウィンドウに「AI 添削」ボタンを追加し、Claude CLI 経由で文章の改善提案を取得・表示する

**対象ユーザー**: WorkNote を使用してナレッジを記録するすべてのユーザー

---

## 機能要件

### FR-301: AI 添削ボタンの配置

- **種類**: Ubiquitous
- **要件**: システムは常に、詳細入力ウィンドウに「AI 添削」ボタンを表示すること
- **優先度**: 高
- **受入条件**:
  - 詳細入力ウィンドウを開いたとき、「AI 添削」ボタンが表示される
  - ボタンは Markdown プレビューペインの上部または入力フォームの下部に配置される
  - ボタンのラベルは「AI 添削」または「Claude で添削」とする

### FR-302: AI 添削の実行

- **種類**: Event-driven
- **要件**: ユーザーが「AI 添削」ボタンをクリックした場合、システムは Claude CLI コマンドを実行して文章の添削を実行すること
- **優先度**: 高
- **受入条件**:
  - ボタンクリック時に、入力中の Markdown 文章を Claude に送信する
  - Claude に送信するプロンプトは以下を含む:
    - 「この Markdown 文章を添削してください」
    - 「タイポ修正、文章構成の改善、不足している情報の補足を提案してください」
  - Claude CLI コマンド（`claude-code` または類似コマンド）を Rust から実行する
  - コマンド実行中は、ローディング表示を行う

### FR-303: 添削結果のインライン差分表示

- **種類**: Ubiquitous
- **要件**: システムは常に、添削結果を GitHub PR 風のインライン差分形式で表示すること
- **優先度**: 高
- **受入条件**:
  - 削除箇所は赤色（または取り消し線）で表示
  - 追加箇所は緑色（または下線）で表示
  - 差分表示は行単位または文字単位で行う
  - 元の文章と添削後の文章を並べて表示する（左右分割または上下分割）

### FR-304: 添削提案の受け入れ・却下

- **種類**: Event-driven
- **要件**: ユーザーが添削提案を確認した場合、システムは「すべて受け入れる」「すべて却下する」ボタンを提供すること
- **優先度**: 中
- **受入条件**:
  - 「すべて受け入れる」ボタンをクリックすると、元の入力フィールドに添削後の文章を反映する
  - 「すべて却下する」ボタンをクリックすると、差分表示を閉じて元の文章を維持する
  - 受け入れ後は、差分表示を閉じる

### FR-305: 添削種類の統合実行

- **種類**: Ubiquitous
- **要件**: システムは常に、以下の添削種類をすべて一度に実行すること
- **優先度**: 中
- **受入条件**:
  - タイポ修正（スペルミス、誤字脱字）
  - 文章構成の改善（読みやすさ、論理的な流れ）
  - 不足している情報の補足（文脈から推測される追加情報）
  - ユーザーが添削種類を選択する UI は提供しない（Phase 4 以降で検討）

### FR-306: エラーハンドリング

- **種類**: Unwanted
- **要件**: Claude CLI コマンドが失敗した場合、システムはエラーメッセージを表示し、元の文章を保持すること
- **優先度**: 高
- **受入条件**:
  - コマンド実行失敗時、「AI 添削に失敗しました」というエラーメッセージを表示
  - エラー詳細（例: Claude CLI が見つからない、API キーが無効）を表示
  - ユーザーの入力データは失われない

---

## 非機能要件

### NFR-301: パフォーマンス

- **種類**: Ubiquitous
- **要件**: システムは常に、AI 添削の実行時間を 30 秒以内に完了すること
- **優先度**: 中
- **受入条件**:
  - Claude API のレスポンスタイムに依存するが、30 秒以内を目標とする
  - タイムアウト時間を設定し、30 秒を超えた場合はエラーメッセージを表示
  - ローディング表示により、ユーザーに処理中であることを伝える

### NFR-302: セキュリティ

- **種類**: Unwanted
- **要件**: システムは、ユーザーの入力文章を外部に送信する際、機密情報を含まないことを確認してはならない（ユーザーの責任）
- **優先度**: 中
- **受入条件**:
  - 警告メッセージを表示: 「この機能は Claude AI に文章を送信します。機密情報を含まないことを確認してください」
  - ユーザーが明示的に「AI 添削」ボタンをクリックしない限り、文章は送信されない
  - Claude CLI の認証情報（API キー等）は、環境変数または設定ファイルで管理する

### NFR-303: ユーザビリティ

- **種類**: Ubiquitous
- **要件**: システムは常に、AI 添削機能の使用方法をユーザーに明示すること
- **優先度**: 低
- **受入条件**:
  - 「AI 添削」ボタンにツールチップを表示: 「Claude で文章を添削します」
  - 初回使用時に、簡単な説明を表示（オプション）

### NFR-304: 拡張性

- **種類**: Optional
- **要件**: 必要に応じて、システムは将来的に添削種類の選択（タイポのみ、構成のみ等）をサポートしてもよい
- **優先度**: 低
- **受入条件**:
  - Phase 3 では実装しないが、設計時に考慮する
  - Phase 4 以降で、チェックボックスによる添削種類の選択機能を追加可能とする

---

## 技術要件

### TR-301: Claude CLI コマンド実行

- **種類**: Ubiquitous
- **要件**: システムは常に、Rust `std::process::Command` を使用して Claude CLI コマンドを実行すること
- **優先度**: 高
- **受入条件**:
  - `claude-code` コマンドまたは類似の CLI ツールを使用
  - 標準入出力を通じて、プロンプトと応答をやり取りする
  - コマンド実行のタイムアウトを設定（30 秒）

### TR-302: 差分表示ライブラリ

- **種類**: Ubiquitous
- **要件**: システムは常に、フロントエンドで差分表示を行うライブラリを使用すること
- **優先度**: 高
- **受入条件**:
  - JavaScript/TypeScript の diff ライブラリを使用（例: `diff-match-patch`, `jsdiff`）
  - Svelte コンポーネントとして実装
  - GitHub PR 風のスタイル（赤・緑の色分け）

### TR-303: プロンプト設計

- **種類**: Ubiquitous
- **要件**: システムは常に、以下の構造でプロンプトを設計すること
- **優先度**: 高
- **受入条件**:
  ```text
  あなたは Markdown 文章の添削アシスタントです。以下の文章を添削してください：

  - タイポ修正（スペルミス、誤字脱字）
  - 文章構成の改善（読みやすさ、論理的な流れ）
  - 不足している情報の補足

  元の文章:
  {user_input}

  添削後の文章を Markdown 形式で返してください。変更箇所のみを返すのではなく、全文を返してください。
  ```

---

## 制約条件

### C-301: Claude CLI の可用性

- **制約**: Claude CLI コマンド（`claude-code`）がユーザーの環境にインストールされている必要がある
- **対処**:
  - 初回使用時に、Claude CLI がインストールされているか確認
  - インストールされていない場合、エラーメッセージとインストール手順を表示

### C-302: API 利用制限

- **制約**: Claude API には利用制限（リクエスト数、トークン数）が存在する
- **対処**:
  - ユーザーに API 利用制限について通知
  - エラー時に、利用制限に関するメッセージを表示

### C-303: ネットワーク接続

- **制約**: Claude API への接続にはインターネット接続が必要
- **対処**:
  - ネットワークエラー時に、適切なエラーメッセージを表示
  - オフライン時は「AI 添削」ボタンを無効化またはグレーアウト

---

## 対象外（Out of Scope）

以下は Phase 3 の対象外とし、Phase 4 以降で検討します：

- 添削種類の選択機能（タイポのみ、構成のみ等）
- 部分的な受け入れ・却下（差分の一部のみを適用）
- 添削履歴の保存・管理
- 複数言語対応（英語以外の文章添削）
- グローバルショートカットの権限問題解決

---

## 受入テスト

### AT-301: AI 添削ボタンの表示

1. 詳細入力ウィンドウを開く
2. 「AI 添削」ボタンが表示されることを確認

### AT-302: AI 添削の実行

1. 詳細入力ウィンドウに Markdown 文章を入力
2. 「AI 添削」ボタンをクリック
3. ローディング表示が出ることを確認
4. 添削結果が差分形式で表示されることを確認

### AT-303: 添削結果の受け入れ

1. 添削結果が表示された状態で、「すべて受け入れる」ボタンをクリック
2. 元の入力フィールドに添削後の文章が反映されることを確認
3. 差分表示が閉じることを確認

### AT-304: 添削結果の却下

1. 添削結果が表示された状態で、「すべて却下する」ボタンをクリック
2. 元の文章が維持されることを確認
3. 差分表示が閉じることを確認

### AT-305: エラーハンドリング

1. Claude CLI が利用できない環境で「AI 添削」ボタンをクリック
2. エラーメッセージが表示されることを確認
3. 元の文章が保持されることを確認

---

## 参照

- **マスタードキュメント**: `docs/master-docs/` （存在しない場合は作成）
- **Phase 1 要件定義**: `docs/michi/20260131-worknote/spec/requirements.md` （存在する場合）
- **Phase 2 要件定義**: `docs/michi/20260131-worknote/spec/phase2-requirements.md` （存在する場合）
- **EARS 形式ガイドライン**: [Easy Approach to Requirements Syntax](https://www.researchgate.net/publication/221149534_Easy_Approach_to_Requirements_Syntax_EARS)

---

## 変更履歴

| 日付       | バージョン | 変更内容 | 作成者      |
| ---------- | ---------- | -------- | ----------- |
| 2026-02-01 | 1.0        | 初版作成 | Claude Code |

---

## 承認

| 役割               | 氏名 | 日付 | 署名 |
| ------------------ | ---- | ---- | ---- |
| プロダクトオーナー | -    | -    | -    |
| 開発リード         | -    | -    | -    |

---

**次のステップ**: 設計書作成（`/michi:create-design phase3-ai-proofreader`）
